# Spašavanje historije razgovora i automatizacija

U prethodnoj lekciji smo unaprijedili interfejs našeg chatbota. Međutim, glavni problem ostaje: svaki put kada zatvorimo aplikaciju, gubimo kompletnu historiju razgovora. U ovoj lekciji, riješit ćemo taj problem tako što ćemo implementirati funkciju za spašavanje i učitavanje razgovora, a usput ćemo naučiti i nekoliko trikova za automatizaciju našeg radnog procesa.

## 1. Planiranje sistema za čuvanje historije

Prije nego što napišemo ijednu liniju koda, moramo isplanirati kako će naš sistem funkcionisati.

**1. Definisanje problema:**

- Aplikacija je "bez pamćenja" (*stateless*). Ne sjeća se prethodnih razgovora.
- Slanje kompletne historije nazad AI modelu pri svakoj poruci je neefikasno i
troši previše tokena, što bi u realnoj situaciji mnogo koštalo.

**2. Odabir formata za spašavanje:**

- Odlučili smo se za **JSON (JavaScript Object Notation)** format.
- **Zašto JSON?** Zato što je strukturiran, lako čitljiv i za ljude i za mašine, te idealan za čuvanje podataka koji imaju parove ključ-vrijednost (npr. "naslov": "Glavni gradovi Balkana").

```json
{
  "id": "chat_12345",
  "title": "Glavni gradovi Balkana",
  "date_time": "2025-08-23T20:37:00",
  "language": "bs",
  "complete_chat_history": [
    {"role": "user", "content": "Možeš li mi nabrojati glavne gradove balkanskih zemalja?"},
    {"role": "assistant", "content": "Naravno! Glavni gradovi balkanskih zemalja su: Sarajevo (Bosna i Hercegovina), Beograd (Srbija), Zagreb (Hrvatska), Ljubljana (Slovenija), Skopje (Sjeverna Makedonija), Podgorica (Crna Gora), Tirana (Albanija), Sofija (Bugarska), Bukurešt (Rumunija), Atina (Grčka)."},
    {"role": "user", "content": "Koji od ovih gradova ima najveću populaciju?"},
    {"role": "assistant", "content": "Bukurešt, glavni grad Rumunije, ima najveću populaciju među balkanskim glavnim gradovima sa oko 1.8 miliona stanovnika."}
  ],
  "summarized_chat_history": "Razgovor o glavnim gradovima balkanskih zemalja. Korisnik je pitao za listu glavnih gradova (Sarajevo, Beograd, Zagreb, Ljubljana, Skopje, Podgorica, Tirana, Sofija, Bukurešt, Atina). Također se raspravljalo o tome koji grad ima najveću populaciju - to je Bukurešt sa oko 1.8 miliona stanovnika."
}
```

Ova struktura prati sve navedene zahtjeve iz vaše dokumentacije, sa ID-om, naslovom, datumom i vremenom, jezikom, kompletnom historijom razgovora i sažetkom za efikasno korištenje tokena.

**3. Dizajniranje strukture JSON fajla:**

Svaki sačuvani razgovor bit će jedan JSON fajl. Isplanirali smo da svaki fajl sadrži sljedeće informacije (polja):

- **id:** **Jedinstveni identifikator** za svaki razgovor (da se fajlovi ne preklapaju).
- **title:**
    - **Kratak naslov razgovora,** automatski generisan od strane AI modela (npr. "Glavni gradovi i historija").
- **date_time:**
    - Tačan datum i vrijeme kada je razgovor sačuvan.
- **language:**
    - Jezik na kojem se vodio razgovor (npr. "bs" za bosanski).
- **complete_chat_history:**
    - **Kompletna historija razgovora.** Ovo polje služi samo da bismo mi mogli vidjeti cijeli razgovor kada ga ponovo učitamo.
- **summarized_chat_history:**
    - **Sažetak razgovora (**do 4000 tokena). Ovo je ključno polje.
    - Umjesto slanja cijele historije, AI modelu ćemo slati samo ovaj sažetak kako bi dobio kontekst o čemu smo pričali.

## 2. Implementacija pomoću Gemini CLI

Sada kada imamo plan, koristit ćemo Gemini CLI da nam generiše potreban kod.

**1. Kreiranje funkcije za spašavanje razgovora:**

U terminalu pokrenite Gemini-CLI i zadajte mu sljedeći detaljan upit na engleskom:

```
We need a button to save chat history to a JSON file. The JSON file should be saved in a folder named "archive". The JSON file needs to have these fields: a unique auto-generated ID, a title summarized from the conversation (max 10 words, in Bosnian), the current date and time, the detected language of the conversation (as ISO 639-1 code), the complete chat history, and a summarized chat history (max 4000 tokens).
```

Gemini će analizirati app.py i dodati dugme "Save Chat", kao i svu potrebnu logiku za kreiranje i popunjavanje JSON fajla prema našim uputama.

**2. Kreiranje funkcije za učitavanje i nastavak razgovora:**

Sada nam treba način da učitamo sačuvane razgovore i nastavimo gdje smo stali. Dajte Gemini-ju novi zadatak: 

```
Display all saved chats from the "archive" folder in the sidebar. When a user clicks on a chat, load its history into the chat window and allow the user to continue the conversation.
```

**Ključni korak – optimizacija tokena:** Moramo osigurati da se ne šalje kompletna historija. Zato ćemo precizirati zahtjev: 

```
When a conversation is loaded and the user sends a new message, the application should only send the content from the 'summarized_chat_history' field to Gemini for context, notthe entire chat history. Also, add a button 'New Chat' to start a fresh session.
```

Gemini će sada podesiti logiku tako da, pri nastavku razgovora, AI model dobije samo efikasan sažetak, čime štedimo tokene i ubrzavamo odgovor.

## 3. Automatizacija i poboljšanje radnog procesa

Da bismo izbjegli ponavljanje istih komandi, uvest ćemo dva korisna trika.

### 1. Kreiranje run.bat skripte za brzo pokretanje

Stalno kucanje .venv\Scripts\activate i streamlit run app.py je zamorno. Automatizirat ćemo to.

U folderu vašeg projekta, kreirajte novi tekstualni fajl i nazovite ga run.bat (potrebno je uključiti prikazivanje ekstenzija ako to niste do sada učinili).

Otvorite ga i unesite sljedeću komandu u jednom redu: 

```
.venv\Scripts\activate && streamlit run app.py
```

**Šta ova komanda radi?** && znači "ako je prva komanda uspješna, onda pokreni drugu". Dakle,
skripta prvo aktivira virtuelno okruženje, a odmah zatim pokreće Streamlit aplikaciju.

Sada, umjesto kucanja u terminalu, samo trebate dva puta kliknuti na run.bat fajl da biste pokrenuli vašu aplikaciju.

### 2. Kreiranje gemini.md fajla za stalne instrukcije

Primijetili ste da Gemini-ju često ponavljamo iste stvari (npr. "koristi uv", "kod piši na engleskom", "komentare na bosanskom"). To možemo definisati jednom za sva vremena.

U korijenu vašeg projektnog foldera, kreirajte novi fajl i nazovite ga gemini.md.

Ovo je Markdown fajl u koji možete upisati stalne instrukcije za Gemini. Kada pokrenete gemini komandu, on će prvo pročitati ovaj fajl i primijeniti ta pravila na sve vaše buduće zahtjeve.

**Primjer sadržaja za gemini.md:** 

```markdown
# General Instructions
- Always use `uv` for installing Python packages.
- Always load the Gemini API key from environment variables.
- When creating a chatbot, always use the Streamlit library.

# Coding Style
- Code variables should be in English.
- Comments should always be on a single line and in the Bosnian language.
```

Ovaj fajl drastično ubrzava rad jer postavlja osnovna pravila koja Gemini uvijek prati, bez potrebe da ih vi ponavljate.