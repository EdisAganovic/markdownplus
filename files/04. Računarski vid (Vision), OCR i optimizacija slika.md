# Računarski vid (Vision), OCR i optimizacija slika

U ovoj lekciji naučit ćemo kako proširiti mogućnosti našeg chatbota tako da može obrađivati i analizirati slike (multimodalna sposobnost). Fokus je na optičkom prepoznavanju znakova (OCR) i optimizaciji slika kako bismo smanjili potrošnju tokena.

## 1. Razumijevanje optimizacije slika (Zašto štedimo tokene?)

Što je veća slika (u pikselima), to je više tokena potrebno AI modelu da je obradi, što direktno utiče na cijenu i brzinu odgovora. Prije slanja slike na Gemini API, moramo je optimizovati.

[Vision - Anthropic](https://docs.anthropic.com/en/docs/build-with-claude/vision)

**Glavne tehnike optimizacije koje koristimo:**

1. **Konverzija formata:**
    - Formati poput **PNG** (visok kvalitet, veliki fajlovi, npr. 700 KB) mogu trošiti više tokena (ako se snimaju u Base64 formatu) od optimizovanih formata poput **WebP** (npr. 120 KB). WebP, Googleov format, nudi sličan vizuelni kvalitet uz manju veličinu. Svakako treba brinuti i o prostoru na serveru.
2. **Smanjenje rezolucije (*Resize*):**
    - Slanje slike rezolucije 7000x7000 piksela nema smisla ako nam treba samo tekst. Svakako mnogi modeli imaju svoje limite po pitanuju rezolucije.
    - Maksimalnu rezoluciju ćemo ograničiti npr. **1024x1024 piksela**, uz obavezno **očuvanje proporcija** originalne slike. Provjerite specifikacije svakog modela za njihove limite po pitanju rezolucije.
3. **Pretvaranje u crno bijelo (*Grayscale*):**
    - Uklanjanje boje dodatno smanjuje veličinu fajla. Ipak ovo može zavisiti od modela do modela na koji način analizira slike po pitanju boja.
4. **Binarizacija:**
    
    ![image.png](/files/images/04_image.png)
    
- Ovo je ključna tehnika za OCR. Sliku pretvara u čistu crno-bijelu (bez sivih tonova), ističući tekstualne elemente i uklanjajući pozadinske smetnje, sjene ili nečistoće. Ovo poboljšava tačnost prepoznavanja teksta.
- Postoje još raznorazne druge opcije poboljšavanja i priprema dokumenata za OCR koje možete sami istražiti: CLAHE + Binirazation, Local adaptive tresholding (Sauvola, Niblack, Wolf), Global treshold.

## 2. Vision vs OCR

OCR (Optical Character Recognition) i Vision tehnologije imaju različite uloge u obradi dokumenata. **OCR** je specijalizirana tehnologija koja prepoznaje i konvertuje tekst iz skeniranih dokumenata ili slika u digitalni čitljiv oblik. Njegov primarni cilj je identifikacija znakova i pretvaranje fizičkih dokumenata (poput PDF-ova, faktura ili skeniranih ugovora) u format koji omogućava pretragu, kopiranje i dalju obradu. OCR je usmjeren isključivo na tekstualni sadržaj i njegovu preciznu reprodukciju, dok je njegova sposobnost prepoznavanja struktura (tabele, logotipi, grafikoni) ograničena.

**Computer Vision** pristup je širi i obuhvata ne samo tekst, nego i vizuelne elemente dokumenta, kao što su grafikoni, slike, pečati, potpisi, logotipi ili čak raspored elemenata na stranici. Vision algoritmi omogućavaju razumijevanje kompletne vizuelne strukture dokumenta, uključujući klasifikaciju, prepoznavanje obrazaca i ekstrakciju konteksta, a često u sebi koriste i OCR kao jednu komponentu. Dakle, dok OCR „vidi“ samo znakove i slova, Vision sistemi razumiju cijelu stranicu kao kombinaciju teksta i vizuelnih elemenata, što omogućava dublju analizu i automatizaciju procesa poput kategorizacije dokumenata ili validacije njihovog sadržaja.

Najbolja praksa je pretvaranje ovakvih podataka u Markdown format koji je mnogo fleksibilniji za dalju obradu podataka.

## **2. Razvoj posebnog modula za obradu slika**

Da bi naša aplikacija bila bolje organizovana kreirat ćemo zaseban modul (files/images/04_image.py) koji će raditi isključivo obradu slika.

**1. Kreiranje image.py modula putem AI-ja:**

- U terminalu pokrenite Gemini i zadajte mu da napravi novi fajl:
    
    ```
    Make new image.py file. We will use Streamlit to upload image, convert it to WebP, resize it to max 1024x1024 (do not change proportions), convert it to grayscale, and add a slider for local adaptive binarization for debugging purposes. Also, show image size before and after processing, and add a download button. Use UV pip to install anynew required packages.
    ```
    
- *AI će instalirati potrebne pakete (poput opencv-python i Pillow). Ne zaboravite da spremite [QWEN.md](http://QWEN.md) ili [Gemini.md](http://Gemini.md) sa instrukcijama kako će instalirati ove pakete.*

**2. Testiranje optimizacije:**

- Pokrenite samo novi modul za testiranje: streamlit run image.py.
- Ubacite veliku testnu sliku (npr. ugovor neki sa interneta).
- **Rezultat:** Vidjeli smo da je slika npr. sa **1.3 MB** smanjena na samo **52 KB**! Ova ogromna ušteda direktno štedi tokene i resurse na serveru.
- **Eksperimentisanje sa binarizacijom:** Pomoću klizača (slidera) možete na licu mjesta testirati kako različite postavke binarizacije poboljšavaju tekst. Zaključili smo da je **adaptivna lokalna binarizacija** bolja jer se prilagođava različitim dijelovima dokumenta.

**3. Priprema modula za integraciju:**

- Kada smo zadovoljni postavkama u **image.py**, pretvaramo ga u funkciju koju može pozvati glavni fajl.
- U terminalu zadajte komandu da AI očisti kod:

```
Remove Streamlit elements from image.py and put all image processing code into a function named 'process_image'.
```

- Funkcija **process_image** sada prima ulaznu sliku i vraća optimizovanu sliku, spremnu za slanje.

## 3. Integracija sa Chatbotom

**1. Dodavanje mogućnosti uploada u app.py:**

- Sada se vraćamo na glavni fajl (app.py). Pokrenite Gemini i zadajte mu da omogući upload:

```
In app.py, make an option to upload an image. Import the 'process_image' function from the 'image.py' file and use it to optimize the uploaded image. After processing, send theoptimized image along with the user's text prompt to the Gemini API.
```

- AI će u vaš app.py dodati liniju **from image import process_image** i implementirati logiku za slanje slike modelu.

**2. Testiranje OCR-a i analize slike:**

![image.png](/files/images/04_image%201.png)

- Pokrenite chatbot (streamlit run app.py).
- Ubacite optimizovanu sliku ugovora i dajte upit: *„Koje su stranke u ovom ugovoru i daj mi kompletan tekst sa slike?“*
- **Rezultat:** Gemini je uspješno prepoznao optimizovanu sliku, pročitao je (OCR) i ispravio eventualne gramatičke greške u transkripciji i dao vam odgovor.

**3. Rješavanje problema čuvanja slika u historiji:**

- **Problem:** Kada sačuvamo chat, slike nestaju. Snimanje slike u JSON fajlu rješava ovaj problem.
- Koristite AI da implementirate **Base64 kodiranje**:

```
When we save chat, images are not included. Modify the saving function to encode the image data using Base64 and store it within the JSON chat history.
```

![image.png](/files/images/04_image%202.png)

- AI će sada slike pretvoriti u dugačak tekstualni niz i sačuvati ih u JSON fajlu. Pri učitavanju chata, kod dekodira Base64 i prikazuje sliku, čime je historija razgovora sa slikama trajno sačuvana.

## Zaključak:

Naučili smo da je optimizacija ključna za rad sa vizuelnim modelima i uspješno smo podijelili kompleksan zadatak obrade slika u poseban, čist modul, olakšavajući razvoj i održavanje glavne aplikacije.